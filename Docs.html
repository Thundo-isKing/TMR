<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docs ~ Write & Edit</title>
    <script>
        (function () {
            try {
                var raw = localStorage.getItem('tmr_boot_theme');
                if (!raw) {
                    try {
                        var lastUid = (typeof sessionStorage !== 'undefined') ? sessionStorage.getItem('tmr_last_user_id') : null;
                        if (lastUid) {
                            raw = localStorage.getItem('tmr_user_' + lastUid + '_tmr_boot_theme');
                        }
                        if (!raw) raw = localStorage.getItem('tmr_anon_tmr_boot_theme');

                        if (!raw && lastUid) {
                            var accent2 = localStorage.getItem('tmr_user_' + lastUid + '_theme_accent_color') || localStorage.getItem('tmr_user_' + lastUid + '_tmr_accent') || null;
                            var bg2 = localStorage.getItem('tmr_user_' + lastUid + '_theme_bg_image') || localStorage.getItem('tmr_user_' + lastUid + '_tmr_bg_image') || null;
                            var anim2 = localStorage.getItem('tmr_user_' + lastUid + '_theme_animation') || null;
                            if (accent2 || bg2 || anim2) {
                                raw = JSON.stringify({
                                    accentColor: accent2,
                                    backgroundImage: bg2,
                                    animation: anim2,
                                    updatedAt: Date.now()
                                });
                                try { localStorage.setItem('tmr_boot_theme', raw); } catch (_) {}
                            }
                        }

                        if (!raw && !lastUid) {
                            var aAccent = localStorage.getItem('tmr_anon_theme_accent_color') || localStorage.getItem('tmr_anon_tmr_accent') || null;
                            var aBg = localStorage.getItem('tmr_anon_theme_bg_image') || localStorage.getItem('tmr_anon_tmr_bg_image') || null;
                            var aAnim = localStorage.getItem('tmr_anon_theme_animation') || null;
                            if (aAccent || aBg || aAnim) {
                                raw = JSON.stringify({
                                    accentColor: aAccent,
                                    backgroundImage: aBg,
                                    animation: aAnim,
                                    updatedAt: Date.now()
                                });
                                try { localStorage.setItem('tmr_boot_theme', raw); } catch (_) {}
                            }
                        }
                    } catch (_) {}
                }
                if (!raw) return;
                var theme = JSON.parse(raw);
                if (!theme || typeof theme !== 'object') return;

                var accent = (typeof theme.accentColor === 'string') ? theme.accentColor.trim() : '';
                var accentRgb = (typeof theme.accentRgb === 'string') ? theme.accentRgb.trim() : '';
                var bg = (typeof theme.backgroundImage === 'string') ? theme.backgroundImage : '';

                if (!accent || accent === 'null' || accent === 'undefined') accent = '';
                if (!accentRgb || accentRgb === 'null' || accentRgb === 'undefined') accentRgb = '';
                if (!bg || bg === 'null' || bg === 'undefined') bg = '';

                if (accent && !accentRgb) {
                    if (accent[0] === '#') {
                        var hex = accent.slice(1);
                        if (hex.length === 3) hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2];
                        if (/^[0-9a-fA-F]{6}$/.test(hex)) {
                            accentRgb = parseInt(hex.slice(0, 2), 16) + ',' +
                                parseInt(hex.slice(2, 4), 16) + ',' +
                                parseInt(hex.slice(4, 6), 16);
                        }
                    }

                    if (!accentRgb && typeof getComputedStyle === 'function') {
                        try {
                            var probe = document.createElement('span');
                            probe.style.color = accent;
                            probe.style.display = 'none';
                            document.documentElement.appendChild(probe);
                            var computed = getComputedStyle(probe).color;
                            probe.remove();
                            var m = computed && computed.match(/rgba?\((\d+)\s*,\s*(\d+)\s*,\s*(\d+)/i);
                            if (m) accentRgb = m[1] + ',' + m[2] + ',' + m[3];
                        } catch (_) {}
                    }
                }

                var root = document.documentElement;
                if (accent) root.style.setProperty('--accent-color', accent);
                if (accentRgb) root.style.setProperty('--accent-rgb', accentRgb);

                if (bg) {
                    var safe = bg.replace(/'/g, "\\'");
                    root.style.setProperty('--tmr-boot-bg-image', "url('" + safe + "')");

                    if (!/^data:/i.test(bg)) {
                        try {
                            var preload = document.createElement('link');
                            preload.rel = 'preload';
                            preload.as = 'image';
                            preload.href = bg;
                            document.head.appendChild(preload);
                        } catch (_) {}
                    }

                    var style = document.createElement('style');
                    style.id = 'tmr-boot-theme-style';
                    style.textContent = 'html,body{' +
                        'background-image:var(--tmr-boot-bg-image) !important;' +
                        'background-size:cover !important;' +
                        'background-position:center !important;' +
                        'background-repeat:no-repeat !important;' +
                        'background-attachment:fixed !important;' +
                    '}';
                    document.head.appendChild(style);
                }
            } catch (e) {
                // ignore
            }
        })();
    </script>
    <link rel="stylesheet" href="TMR.css?v=20251231z">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Product+Sans:wght@400;500;700&display=swap');

        * {
            box-sizing: border-box;
            font-family: 'Product Sans', Arial, Helvetica, sans-serif;
        }

        body, button, input, label, span, div, h1, h2, h3, h4, h5, h6, p {
            font-weight: bold;
        }

        body {
            margin: 0;
            padding: 12px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            height: 100vh;
            overflow: hidden;
            position: relative;
            background-color: white;
            background-image: 
                linear-gradient(60deg, transparent 45%, rgba(var(--accent-rgb, 0,157,255), 0.18) 45%, rgba(var(--accent-rgb, 0,157,255), 0.18) 55%, transparent 55%),
                linear-gradient(-60deg, transparent 45%, rgba(var(--accent-rgb, 0,157,255), 0.18) 45%, rgba(var(--accent-rgb, 0,157,255), 0.18) 55%, transparent 55%),
                linear-gradient(60deg, rgba(var(--accent-rgb, 0,157,255), 0.09) 45%, transparent 45%, transparent 55%, rgba(var(--accent-rgb, 0,157,255), 0.09) 55%),
                linear-gradient(-60deg, rgba(var(--accent-rgb, 0,157,255), 0.09) 45%, transparent 45%, transparent 55%, rgba(var(--accent-rgb, 0,157,255), 0.09) 55%);
            background-size: 300px 300px, 300px 300px, 300px 300px, 300px 300px;
        }

        .docs-container {
            display: flex;
            height: 100vh;
            gap: 12px;
            width: 65%;
            margin: 0 auto;
        }

        /* Editor Area */
        .editor-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .editor-header {
            padding: 16px 24px;
            background: transparent;
            color: var(--accent-color, #667eea);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            flex-shrink: 0;
            border-bottom: none;
        }

        .editor-header h1 {
            display: none;
        }

        .editor-title-input {
            flex: 1;
            padding: 12px 16px;
            background: white;
            border: 1.5px solid #ddd;
            border-radius: 16px;
            color: #333;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .editor-title-input::placeholder {
            color: #999;
        }

        .editor-title-input:focus {
            outline: none;
            border-color: var(--accent-color, #667eea);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .editor-header-controls {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .save-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--accent-color, #667eea);
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }

        .save-status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: white;
        }

        .save-status.saving .save-status-dot {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .editor-toolbar {
            padding: 12px 16px;
            background: transparent;
            border-bottom: none;
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
            flex-wrap: wrap;
        }

        .toolbar-group {
            display: flex;
            gap: 4px;
            padding: 0 8px;
            border-right: 1px solid rgba(0, 0, 0, 0.1);
        }

        .toolbar-group:last-child {
            border-right: none;
        }

        .toolbar-btn {
            width: 36px;
            height: 36px;
            padding: 0;
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid transparent;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toolbar-btn:hover {
            background: white;
            border-color: var(--accent-color, #667eea);
        }

        .toolbar-btn.active {
            background: white;
            color: var(--accent-color, #667eea);
            border-color: var(--accent-color, #667eea);
            transform: scale(0.85);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .toolbar-input {
            padding: 6px 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            background: white;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .toolbar-input:hover {
            border-color: var(--accent-color, #667eea);
        }

        .editor-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            position: relative;
        }

        .editor-text {
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
            color: #333;
            font-size: 16px;
            line-height: 1.6;
            resize: none;
            font-family: 'Segoe UI', Roboto, sans-serif;
            font-weight: normal;
            outline: none;
            padding: 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
        }

        .editor-text:empty:before {
            content: attr(data-placeholder);
            color: #444;
            pointer-events: none;
        }

        /* Toolbar Sidebar */
        .toolbar-sidebar {
            position: fixed;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            padding: 8px;
            z-index: 1000;
            display: none;
            flex-direction: column;
            gap: 4px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .toolbar-sidebar.active {
            display: flex;
        }

        .toolbar-sidebar-btn {
            width: 44px;
            height: 44px;
            padding: 0;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toolbar-sidebar-btn:hover {
            border-color: var(--accent-color, #667eea);
            background: #f5f7ff;
        }

        .toolbar-sidebar-btn.active {
            background: var(--accent-color, #667eea);
            color: white;
            border-color: var(--accent-color, #667eea);
        }

        /* Meibot Button */
        .meibot-btn {
            position: fixed;
            bottom: 49px;
            right: 24px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--accent-color, #667eea);
            border: none;
            color: white;
            font-size: 32px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }

        .meibot-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(102, 126, 234, 0.6);
        }

        .meibot-btn:active {
            transform: scale(0.95);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .modal-header {
            padding: 20px;
            background: var(--accent-color, #667eea);
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 700;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .modal-footer {
            padding: 16px 20px;
            background: #f5f5f5;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-footer input {
            flex: 1;
            padding: 8px 12px;
            border: 1.5px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .modal-footer input:focus {
            outline: none;
            border-color: var(--accent-color, #667eea);
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .modal-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .modal-btn.cancel {
            background: #f0f0f0;
            color: #333;
        }

        .modal-btn.cancel:hover {
            background: #e0e0e0;
        }

        .modal-btn.submit {
            background: var(--accent-color, #667eea);
            color: white;
        }

        .modal-btn.submit:hover {
            opacity: 0.9;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        /* Task Extraction UI */
        .task-item {
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .task-item-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .task-item-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .task-item-action {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .task-item-action.skip {
            background: #f0f0f0;
            color: #666;
        }

        .task-item-action.skip:hover {
            background: #e0e0e0;
        }

        .task-item-action.add {
            background: var(--accent-color, #667eea);
            color: white;
        }

        .task-item-action.add:hover {
            opacity: 0.9;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .back-btn {
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--accent-color, #667eea);
            white-space: nowrap;
        }

        .back-btn:hover {
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(102, 126, 234, 0.2);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .docs-container {
                padding: 8px;
                gap: 8px;
            }

            .editor-header {
                padding: 12px 16px;
            }

            .editor-header h1 {
                font-size: 18px;
            }

            .editor-content {
                padding: 16px;
            }

            .toolbar-sidebar {
                left: 8px;
            }

            .meibot-btn {
                width: 50px;
                height: 50px;
                bottom: 16px;
                right: 16px;
                font-size: 24px;
            }

            .modal-content {
                width: 95%;
                max-height: 90vh;
            }
        }
    </style>
</head>
<body>
    <div class="docs-container">
        <div class="editor-area">
            <div class="editor-header">
                <input type="text" class="editor-title-input" id="note-title" placeholder="Note title...">
                <div class="editor-header-controls">
                    <div class="save-status" id="save-status">
                        <span class="save-status-dot"></span>
                        <span>Unsaved</span>
                    </div>
                    <button class="back-btn" id="back-btn">Back</button>
                </div>
            </div>
            
            <div class="editor-toolbar">
                <div class="toolbar-group">
                    <button class="toolbar-btn" id="font-decrease" title="Decrease font size">‚àí</button>
                    <span class="toolbar-input" id="font-size-display" style="min-width: 40px; text-align: center;">14</span>
                    <button class="toolbar-btn" id="font-increase" title="Increase font size">+</button>
                </div>
                
                <div class="toolbar-group">
                    <button class="toolbar-btn" id="italic-btn" title="Italic">I</button>
                </div>
                
                <div class="toolbar-group">
                    <input type="color" class="toolbar-input" id="text-color" title="Text color" value="#333333">
                </div>
                
                <div class="toolbar-group">
                    <button class="toolbar-btn" id="bullet-btn" title="Bullet list">‚Ä¢</button>
                    <button class="toolbar-btn" id="number-btn" title="Numbered list">1.</button>
                    <button class="toolbar-btn" id="checkbox-btn" title="Checkbox">‚òê</button>
                </div>

                <div class="toolbar-group">
                    <button class="toolbar-btn" id="meibot-extract" title="Get AI insights">ü§ñ</button>
                </div>
            </div>
            
            <div class="editor-content">
                <div class="editor-text" id="editor-text" contenteditable="true" data-placeholder="Start typing..."></div>
            </div>
        </div>
    </div>

    <!-- Meibot Button -->
    <button class="meibot-btn" id="meibot-btn" title="Chat with Meibot">ü§ñ</button>

    <!-- Meibot Modal -->
    <div class="modal" id="meibot-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Chat with Meibot</h2>
            </div>
            <div class="modal-body" id="meibot-chat">
                <!-- Messages will be rendered here -->
            </div>
            <div class="modal-footer">
                <input type="text" id="meibot-input" placeholder="Ask Meibot...">
                <button class="modal-btn submit" id="meibot-send">Send</button>
            </div>
        </div>
    </div>

    <!-- Task Extraction Modal -->
    <div class="modal" id="task-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add to Todo List</h2>
            </div>
            <div class="modal-body" id="task-list">
                <!-- Tasks will be rendered here -->
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" id="task-cancel">Cancel</button>
                <button class="modal-btn submit" id="task-confirm">Add Selected</button>
            </div>
        </div>
    </div>

    <script src="auth-client.js?v=20260105d"></script>
    <script src="meibot.js?v=20251231z"></script>
    <script>
        // Global state
        function getOrCreateDeviceId() {
            let deviceId = localStorage.getItem('tmr_device_id');
            if (!deviceId) {
                deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).slice(2, 9);
                localStorage.setItem('tmr_device_id', deviceId);
            }
            return deviceId;
        }

        let currentUser = getOrCreateDeviceId();
        let currentNoteId = null;
        let currentFontSize = 14;
        let autoSaveTimeout;
        let selectedTasks = new Set();
        let italicEnabled = false;

        // DOM Elements
        const noteTitle = document.getElementById('note-title');
        const editorText = document.getElementById('editor-text');
        const saveStatus = document.getElementById('save-status');
        const backBtn = document.getElementById('back-btn');
        const meibotBtn = document.getElementById('meibot-btn');
        const meibotModal = document.getElementById('meibot-modal');
        const taskModal = document.getElementById('task-modal');

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                if (window.AuthClient && AuthClient.ready) {
                    await AuthClient.ready;
                }
            } catch (e) {
                console.warn('[Docs] Auth restore failed:', e);
            }

            await loadTheme();
            
            const params = new URLSearchParams(window.location.search);
            currentNoteId = params.get('noteId');

            if (currentNoteId) {
                loadNote();
            } else {
                noteTitle.placeholder = 'Untitled Document';
            }

            setupEventListeners();
            resetFormattingButtons();
        });

        async function loadTheme() {
            let accentColor = null;
            let bgImage = null;
            let accentSource = null;
            let bgSource = null;

            // Local fallback candidates (filled later). We'll use these to avoid
            // overriding a real local accent with the server's default accent.
            let localAccentCandidate = null;
            let localAccentSource = null;

            // Prefer server-saved theme (same as the Themes modal).
            try {
                const resp = await fetch('/theme/load', { credentials: 'include' });
                if (resp.ok) {
                    const data = await resp.json();
                    if (data && data.theme) {
                        if (data.theme.accentColor) { accentColor = data.theme.accentColor; accentSource = 'server:/theme/load'; }
                        if (data.theme.backgroundImage) { bgImage = data.theme.backgroundImage; bgSource = 'server:/theme/load'; }
                    }
                }
            } catch (e) {
                // ignore (offline/server not running)
            }

            // If server theme isn't available, try reading from per-user localStorage keys directly.
            // This works even if auth-client.js failed to load (or scoping isn't active yet).
            if (!accentColor || !bgImage) {
                try {
                    const resp = await fetch('/auth/session', { credentials: 'include' });
                    if (resp.ok) {
                        const data = await resp.json();
                        const uid = data && data.user && data.user.id;
                        if (uid) {
                            if (!accentColor) {
                                accentColor =
                                    localStorage.getItem(`tmr_user_${uid}_theme_accent_color`) ||
                                    localStorage.getItem(`tmr_user_${uid}_tmr_accent`) ||
                                    null;
                                if (accentColor) accentSource = 'localStorage:user_scoped';
                            }
                            if (!bgImage) {
                                bgImage =
                                    localStorage.getItem(`tmr_user_${uid}_theme_bg_image`) ||
                                    localStorage.getItem(`tmr_user_${uid}_tmr_bg_image`) ||
                                    null;
                                if (bgImage) bgSource = 'localStorage:user_scoped';
                            }
                        }
                    }
                } catch (e) {
                    // ignore
                }
            }

            // Capture local candidates (even if server returned something) so we can
            // avoid overriding a real local accent with the server's default.
            localAccentCandidate =
                localStorage.getItem('theme_accent_color') ||
                localStorage.getItem('tmr_accent') ||
                null;
            if (localAccentCandidate) localAccentSource = 'localStorage:fallback';

            // If server returned its default accent, prefer any locally stored accent.
            if (accentSource === 'server:/theme/load' && accentColor === '#6366f1' && localAccentCandidate) {
                accentColor = localAccentCandidate;
                accentSource = localAccentSource;
            }

            // Fallback to per-user localStorage theme keys.
            if (!accentColor) {
                accentColor =
                    localStorage.getItem('theme_accent_color') ||
                    localStorage.getItem('tmr_accent') ||
                    '#0089f1';
                accentSource = 'localStorage:fallback_or_default';
            }
            if (!bgImage) {
                bgImage =
                    localStorage.getItem('theme_bg_image') ||
                    localStorage.getItem('tmr_bg_image');
                if (bgImage) bgSource = 'localStorage:fallback';
            }

            accentColor = normalizeCssColor(accentColor) || '#0089f1';
            document.documentElement.style.setProperty('--accent-color', accentColor);

            const rgb = colorToRgb(accentColor);
            document.documentElement.style.setProperty('--accent-rgb', `${rgb.r},${rgb.g},${rgb.b}`);

            if (bgImage) {
                document.body.style.backgroundImage = `url('${bgImage}')`;
                document.body.style.backgroundSize = 'cover';
                document.body.style.backgroundPosition = 'center';
                document.body.style.backgroundAttachment = 'fixed';
                document.body.style.backgroundRepeat = 'no-repeat';
            }

            // One-time debug log to make it obvious what's being applied.
            try {
                if (!window.__tmrDocsThemeLogged) {
                    window.__tmrDocsThemeLogged = true;
                    console.log('[Docs] Theme applied', {
                        accentColor,
                        accentSource,
                        accentRgb: `${rgb.r},${rgb.g},${rgb.b}`,
                        bgApplied: !!bgImage,
                        bgSource
                    });
                }
            } catch (_) {}
        }
        
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : { r: 0, g: 157, b: 255 };
        }

        function normalizeCssColor(value) {
            if (typeof value !== 'string') return null;
            const v = value.trim();
            if (!v || v === 'null' || v === 'undefined') return null;
            try {
                if (window.CSS && typeof window.CSS.supports === 'function' && !window.CSS.supports('color', v)) {
                    return null;
                }
            } catch (_) {
                // ignore
            }
            return v;
        }

        function colorToRgb(color) {
            // Try hex first (#RRGGBB)
            if (typeof color === 'string') {
                const c = color.trim();
                const rgbHex = hexToRgb(c);
                if (!(rgbHex.r === 0 && rgbHex.g === 157 && rgbHex.b === 255) || /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.test(c)) {
                    return rgbHex;
                }

                // Support #RGB
                const short = /^#?([a-f\d])([a-f\d])([a-f\d])$/i.exec(c);
                if (short) {
                    return {
                        r: parseInt(short[1] + short[1], 16),
                        g: parseInt(short[2] + short[2], 16),
                        b: parseInt(short[3] + short[3], 16)
                    };
                }

                // Fallback: let the browser parse the color.
                try {
                    const el = document.createElement('span');
                    el.style.color = c;
                    document.body.appendChild(el);
                    const computed = getComputedStyle(el).color;
                    document.body.removeChild(el);
                    const m = /^rgb\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)$/i.exec(computed);
                    if (m) {
                        return { r: parseInt(m[1], 10), g: parseInt(m[2], 10), b: parseInt(m[3], 10) };
                    }
                } catch (_) {
                    // ignore
                }
            }

            return { r: 0, g: 157, b: 255 };
        }


        function setupEventListeners() {
            backBtn.addEventListener('click', () => window.location.href = 'NotesHQ.html');
            
            // Toolbar buttons
            document.getElementById('font-decrease').addEventListener('click', () => changeFontSize(-1));
            document.getElementById('font-increase').addEventListener('click', () => changeFontSize(1));
            document.getElementById('italic-btn').addEventListener('click', insertItalic);
            document.getElementById('text-color').addEventListener('change', applyTextColor);
            document.getElementById('bullet-btn').addEventListener('click', insertBullet);
            document.getElementById('number-btn').addEventListener('click', insertNumber);
            document.getElementById('checkbox-btn').addEventListener('click', insertCheckbox);
            document.getElementById('meibot-extract').addEventListener('click', extractTasks);

            // Track formatting state changes
            // (No longer needed - button state is tracked with boldEnabled/italicEnabled flags)

            // Meibot
            meibotBtn.addEventListener('click', openMeibotModal);
            document.getElementById('meibot-send').addEventListener('click', sendMeibotMessage);
            document.getElementById('meibot-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMeibotMessage();
            });

            // Task confirmation
            document.getElementById('task-cancel').addEventListener('click', closeTaskModal);
            document.getElementById('task-confirm').addEventListener('click', confirmTasks);

            // Content changes
            noteTitle.addEventListener('input', scheduleAutoSave);
            editorText.addEventListener('input', scheduleAutoSave);

            // Modal close on backdrop
            meibotModal.addEventListener('click', (e) => {
                if (e.target === meibotModal) closeMeibotModal();
            });
            taskModal.addEventListener('click', (e) => {
                if (e.target === taskModal) closeTaskModal();
            });
        }

        function loadNote() {
            fetch(`/notes/${currentNoteId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.note) {
                        noteTitle.value = data.note.title;
                        editorText.innerHTML = data.note.content;
                        
                        // Remove all background colors (highlighting)
                        const allElements = editorText.querySelectorAll('[style*="background"]');
                        allElements.forEach(el => {
                            el.style.backgroundColor = 'transparent';
                        });
                        
                        updateSaveStatus('saved');
                    }
                })
                .catch(err => {
                    console.error('[Docs] Load note error:', err);
                    updateSaveStatus('error');
                });
        }

        function scheduleAutoSave() {
            clearTimeout(autoSaveTimeout);
            updateSaveStatus('unsaved');
            autoSaveTimeout = setTimeout(saveNote, 2000);
        }

        function saveNote() {
            if (!currentNoteId) {
                updateSaveStatus('error');
                return;
            }

            updateSaveStatus('saving');

            fetch(`/notes/${currentNoteId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    title: noteTitle.value || 'Untitled',
                    content: editorText.innerHTML
                })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        updateSaveStatus('saved');
                    } else {
                        updateSaveStatus('error');
                    }
                })
                .catch(err => {
                    console.error('[Docs] Save error:', err);
                    updateSaveStatus('error');
                });
        }

        function updateSaveStatus(status) {
            const el = saveStatus;
            const statusText = el.querySelector('span:last-child') || el;
            el.classList.remove('saving', 'saved', 'error');
            
            switch(status) {
                case 'saving':
                    statusText.textContent = 'Saving...';
                    el.classList.add('saving');
                    break;
                case 'saved':
                    statusText.textContent = 'Saved';
                    el.classList.add('saved');
                    break;
                case 'unsaved':
                    statusText.textContent = 'Unsaved';
                    break;
                case 'error':
                    statusText.textContent = 'Error';
                    el.classList.add('error');
                    break;
            }
        }

        function changeFontSize(delta) {
            currentFontSize = Math.max(10, Math.min(32, currentFontSize + delta));
            document.getElementById('font-size-display').textContent = currentFontSize;
            editorText.style.fontSize = currentFontSize + 'px';
        }

        function insertItalic() {
            italicEnabled = !italicEnabled;
            editorText.focus();
            document.execCommand('italic', false, null);
            updateButtonAppearance();
            scheduleAutoSave();
        }

        function updateButtonAppearance() {
            const italicBtn = document.getElementById('italic-btn');
            
            if (italicEnabled) {
                italicBtn.classList.add('active');
            } else {
                italicBtn.classList.remove('active');
            }
        }

        // Old function - no longer used, button state tracked with boldEnabled/italicEnabled flags
        // function updateFormattingButtons() {
        //     const boldBtn = document.getElementById('bold-btn');
        //     const italicBtn = document.getElementById('italic-btn');
        //     if (document.queryCommandState('bold')) {
        //         boldBtn.classList.add('active');
        //     } else {
        //         boldBtn.classList.remove('active');
        //     }
        //     if (document.queryCommandState('italic')) {
        //         italicBtn.classList.add('active');
        //     } else {
        //         italicBtn.classList.remove('active');
        //     }
        // }

        function resetFormattingButtons() {
            // Reset buttons on page load - no formatting applied yet
            italicEnabled = false;
            document.getElementById('italic-btn').classList.remove('active');
        }

        function applyTextColor() {
            const color = document.getElementById('text-color').value;
            editorText.focus();
            document.execCommand('foreColor', false, color);
            scheduleAutoSave();
        }



        function insertBullet() {
            editorText.focus();
            document.execCommand('insertUnorderedList', false, null);
            scheduleAutoSave();
        }

        function insertNumber() {
            editorText.focus();
            document.execCommand('insertOrderedList', false, null);
            scheduleAutoSave();
        }

        function insertCheckbox() {
            editorText.focus();
            const span = document.createElement('span');
            span.textContent = '‚òê ';
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                range.insertNode(span);
                range.setStartAfter(span);
                range.collapse(true);
                selection.removeAllRanges();
                selection.addRange(range);
            }
            scheduleAutoSave();
        }

        function insertAtCursor(text) {
            // Deprecated - keeping for reference but not used anymore
            console.log('insertAtCursor is deprecated, use execCommand instead');
        }

        function extractTasks() {
            if (!currentNoteId) {
                alert('Save your note first');
                return;
            }

            fetch('/notes/tasks/extract', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId: currentUser,
                    noteId: currentNoteId,
                    content: editorText.innerText
                })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.tasks && data.tasks.length > 0) {
                        selectedTasks.clear();
                        renderTaskModal(data.tasks);
                        taskModal.classList.add('active');
                    } else {
                        alert('No checkboxes found in your note');
                    }
                })
                .catch(err => {
                    console.error('[Docs] Extract tasks error:', err);
                    alert('Error extracting tasks');
                });
        }

        function renderTaskModal(tasks) {
            const taskList = document.getElementById('task-list');
            taskList.innerHTML = '';

            tasks.forEach((task, index) => {
                const item = document.createElement('div');
                item.className = 'task-item';

                const title = document.createElement('div');
                title.className = 'task-item-title';
                title.textContent = task;

                const actions = document.createElement('div');
                actions.className = 'task-item-actions';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = true;
                checkbox.addEventListener('change', () => {
                    if (checkbox.checked) {
                        selectedTasks.add(task);
                    } else {
                        selectedTasks.delete(task);
                    }
                });

                const label = document.createElement('label');
                label.style.marginLeft = '8px';
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(' Add to Todo'));

                actions.appendChild(label);
                item.appendChild(title);
                item.appendChild(actions);
                taskList.appendChild(item);

                selectedTasks.add(task);
            });
        }

        function confirmTasks() {
            const tasksArray = Array.from(selectedTasks);
            if (tasksArray.length === 0) {
                closeTaskModal();
                return;
            }

            fetch('/notes/tasks/confirm', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId: currentUser,
                    noteId: currentNoteId,
                    tasks: tasksArray
                })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        closeTaskModal();
                        alert(`Added ${data.completed} task(s) to your Todo list`);
                    } else {
                        alert('Error adding tasks');
                    }
                })
                .catch(err => {
                    console.error('[Docs] Confirm tasks error:', err);
                    alert('Error confirming tasks');
                });
        }

        function closeTaskModal() {
            taskModal.classList.remove('active');
            selectedTasks.clear();
        }

        function openMeibotModal() {
            meibotModal.classList.add('active');
            document.getElementById('meibot-input').focus();
        }

        function closeMeibotModal() {
            meibotModal.classList.remove('active');
        }

        function sendMeibotMessage() {
            const input = document.getElementById('meibot-input');
            const message = input.value.trim();
            if (!message) return;

            const chat = document.getElementById('meibot-chat');
            const userMsg = document.createElement('div');
            userMsg.style.marginBottom = '12px';
            userMsg.style.textAlign = 'right';
            userMsg.innerHTML = `<div style="background: #667eea; color: white; padding: 10px 14px; border-radius: 8px; display: inline-block; max-width: 80%;">${escapeHtml(message)}</div>`;
            chat.appendChild(userMsg);

            input.value = '';

            // Call Meibot AI
            callMeibot(message, chat);
        }

        function callMeibot(message, chat) {
            // Get current note content as context
            const noteContent = editorText.innerText;
            
            fetch('/api/meibot', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: message,
                    context: noteContent,
                    userId: currentUser
                })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.reply) {
                        // Display AI response
                        const aiMsg = document.createElement('div');
                        aiMsg.style.marginBottom = '12px';
                        aiMsg.style.textAlign = 'left';
                        aiMsg.innerHTML = `<div style="background: #f0f0f0; color: #333; padding: 10px 14px; border-radius: 8px; display: inline-block; max-width: 80%;">${escapeHtml(data.reply)}</div>`;
                        chat.appendChild(aiMsg);
                        
                        // Handle suggested actions
                        if (data.allActions && data.allActions.length > 0) {
                            handleMeibotActions(data.allActions, chat);
                        }
                        
                        chat.scrollTop = chat.scrollHeight;
                    } else if (data.error) {
                        const errMsg = document.createElement('div');
                        errMsg.style.marginBottom = '12px';
                        errMsg.style.textAlign = 'left';
                        errMsg.innerHTML = `<div style="background: #ffebee; color: #c62828; padding: 10px 14px; border-radius: 8px; display: inline-block;">${escapeHtml(`Error: ${data.error}`)}</div>`;
                        chat.appendChild(errMsg);
                        chat.scrollTop = chat.scrollHeight;
                    } else {
                        console.log('[Docs] Unexpected Meibot response:', data);
                        const errMsg = document.createElement('div');
                        errMsg.style.marginBottom = '12px';
                        errMsg.style.textAlign = 'left';
                        errMsg.innerHTML = `<div style="background: #ffebee; color: #c62828; padding: 10px 14px; border-radius: 8px; display: inline-block;">Unexpected response from Meibot</div>`;
                        chat.appendChild(errMsg);
                        chat.scrollTop = chat.scrollHeight;
                    }
                })
                .catch(err => {
                    console.error('[Docs] Meibot error:', err);
                    const errMsg = document.createElement('div');
                    errMsg.style.marginBottom = '12px';
                    errMsg.style.textAlign = 'left';
                    errMsg.innerHTML = `<div style="background: #ffebee; color: #c62828; padding: 10px 14px; border-radius: 8px; display: inline-block;">${escapeHtml(`Connection error: ${err.message}`)}</div>`;
                    chat.appendChild(errMsg);
                    chat.scrollTop = chat.scrollHeight;
                });
        }

        function handleMeibotActions(actions, chat) {
            if (actions.length === 1) {
                const action = actions[0];
                if (action.type === 'createTodo' && action.data) {
                    createActionButton(
                        `‚úÖ Create: "${action.data.text}"`,
                        '#4caf50',
                        () => {
                            storeMeibotAction('todo', action.data);
                            btn.disabled = true;
                            btn.style.opacity = '0.5';
                            btn.textContent = '‚úÖ Created! (check TMR)';
                        },
                        chat
                    );
                } else if (action.type === 'createEvent' && action.data) {
                    createActionButton(
                        `üìÖ Schedule: "${action.data.title || 'Event'}"`,
                        '#2196f3',
                        () => {
                            storeMeibotAction('event', action.data);
                            btn.disabled = true;
                            btn.style.opacity = '0.5';
                            btn.textContent = 'üìÖ Scheduled! (check TMR)';
                        },
                        chat
                    );
                }
            } else if (actions.length > 1) {
                // Multiple actions - show "Create All" button
                const todosCount = actions.filter(a => a.type === 'createTodo').length;
                const eventsCount = actions.filter(a => a.type === 'createEvent').length;
                let label = '‚ú® Create All';
                if (todosCount > 0 && eventsCount > 0) {
                    label += ` (${todosCount} todos, ${eventsCount} events)`;
                } else if (todosCount > 0) {
                    label += ` (${todosCount} todos)`;
                } else if (eventsCount > 0) {
                    label += ` (${eventsCount} events)`;
                }
                
                createActionButton(label, '#ff9800', () => {
                    let created = 0;
                    for (const action of actions) {
                        if (action.type === 'createTodo' && action.data) {
                            storeMeibotAction('todo', action.data);
                            created++;
                        } else if (action.type === 'createEvent' && action.data) {
                            storeMeibotAction('event', action.data);
                            created++;
                        }
                    }
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.textContent = `‚úÖ Created ${created} items! (check TMR)`;
                }, chat);
            }
        }

        function createActionButton(label, color, onClick, chat) {
            const btn = document.createElement('button');
            btn.textContent = label;
            btn.style.marginTop = '8px';
            btn.style.padding = '10px 14px';
            btn.style.background = color;
            btn.style.color = 'white';
            btn.style.border = 'none';
            btn.style.borderRadius = '6px';
            btn.style.cursor = 'pointer';
            btn.style.fontSize = '13px';
            btn.style.fontWeight = '500';
            btn.style.marginBottom = '12px';
            btn.addEventListener('click', onClick);
            chat.appendChild(btn);
            return btn;
        }

        function storeMeibotAction(type, actionData) {
            // Store action in localStorage for TMR.html to retrieve
            let pendingActions = JSON.parse(localStorage.getItem('meibot_pending_actions') || '[]');
            pendingActions.push({
                type: type,
                data: actionData,
                timestamp: Date.now(),
                source: 'docs'
            });
            localStorage.setItem('meibot_pending_actions', JSON.stringify(pendingActions));
            
            // Show notification and open TMR.html
            alert(`Action stored! Opening TMR.html to complete...`);
            window.open('/TMR.html', '_blank');
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>
